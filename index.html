<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plataforma de Di√°rio de Reuni√µes - M√©todo Kumon</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon.png">
    <meta name="theme-color" content="#0078c1">
    <link href="https://cdn.jsdelivr.net/npm/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        .kpi-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .kpi-card { background: #f8f9fa; border: 1px solid #d1e9f6; border-radius: 8px; padding: 15px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .kpi-number { font-size: 2em; font-weight: bold; color: var(--kumon-blue); display: block; }
        .kpi-label { font-size: 0.9em; color: #555; }
        .chart-container { position: relative; height: 300px; width: 100%; }
        /* NOVO (V2): Estilos para o log de performance */
        .performance-log-container { max-height: 250px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 6px; padding: 10px; background: #fdfdfd; }
        .log-item { display: flex; justify-content: space-between; padding: 8px; border-bottom: 1px solid var(--border-color); font-size: 0.9em; }
        .log-item:last-child { border-bottom: none; }
        .log-item-date { font-weight: 600; color: var(--kumon-blue); }
        .log-item-details { display: flex; gap: 15px; }
        .log-item-details span { color: var(--text-color); }
        /* NOVO (V2): Estilos para o progresso da fila */
        #taskAnalysisProgress {
            width: 100%;
            height: 25px;
            background-color: var(--border-color);
            border-radius: 5px;
            overflow: hidden;
            margin-top: 10px;
        }
        #taskAnalysisProgressBar {
            width: 0%;
            height: 100%;
            background-color: var(--success);
            transition: width 0.3s ease;
            text-align: center;
            line-height: 25px;
            color: white;
            font-weight: 600;
        }
        #taskAnalysisStatus {
            margin-top: 10px;
            font-weight: 600;
            color: var(--kumon-blue);
        }

    </style>
</head>
<body>
    
    <!-- Tela de Login (Inicial) -->
    <div id="login-screen" class="login-container">
        <form id="login-form">
            <img src="icon.png" alt="Kumon Logo" class="login-logo">
            <h2>Plataforma Orientadora</h2>
            <div class="form-group">
                <label for="loginEmail">Email</label>
                <input type="email" id="loginEmail" name="email" required>
            </div>
            <div class="form-group">
                <label for="loginPassword">Senha</label>
                <input type="password" id="loginPassword" name="password" required>
            </div>
            <button type="submit" class="btn btn-primary">Entrar</button>
            <p id="login-error" class="error-message"></p>
        </form>
    </div>

    <!-- Container Principal da Aplica√ß√£o (Oculto por padr√£o) -->
    <div id="app-container" class="hidden">
        
        <!-- Header Fixo -->
        <header class="app-header">
            <div class="header-logo">
                <img src="icon.png" alt="Kumon Logo">
                <span>Plataforma Orientadora</span>
            </div>
            <div class="header-nav">
                <button id="dashboard-btn" class="btn-nav" title="Dashboard Geral">
                    <i class='bx bxs-dashboard'></i>
                </button>
                <button id="system-options-btn" class="btn-nav" title="Op√ß√µes do Sistema (Admin)">
                    <i class='bx bx-cog'></i>
                </button>
                <span id="userEmail" class="user-email"></span>
                <button id="logout-button" class="btn-nav-logout" title="Sair">
                    <i class='bx bx-log-out'></i>
                </button>
            </div>
        </header>

        <!-- Corpo Principal -->
        <main class="main-container">
            
            <!-- Barra Lateral (Lista de Alunos) -->
            <aside class="sidebar">
                <div class="sidebar-header">
                    <h3>Meus Alunos</h3>
                    <button id="addStudentBtn" class="btn-add" title="Adicionar Novo Aluno">+</button>
                </div>
                <div class="search-container">
                    <input type="text" id="studentSearch" placeholder="Buscar aluno...">
                </div>
                <div id="studentList" class="student-list">
                    <!-- Alunos ser√£o carregados aqui pelo app.js -->
                </div>
            </aside>

            <!-- √Årea de Conte√∫do (Detalhes do Aluno) -->
            <section id="contentArea" class="content-area">
                <div id="welcomeScreen" class="welcome-screen">
                    <i class='bx bx-user-pin welcome-icon'></i>
                    <h2>Selecione um aluno</h2>
                    <p>Escolha um aluno na lista ao lado para ver seus detalhes e lan√ßar progressos.</p>
                </div>

                <div id="studentDetail" class="hidden">
                    <!-- Detalhes do Aluno (cabe√ßalho) -->
                    <div class="student-detail-header">
                        <h2 id="studentNameHeader">Nome do Aluno</h2>
                        <div class="student-meta">
                            <span><i class='bx bx-user'></i> Resp: <strong id="studentResponsible"></strong></span>
                            <span><i class='bx bx-phone'></i> Contato: <strong id="studentContact"></strong></span>
                        </div>
                    </div>

                    <!-- M√≥dulos de Est√°gio -->
                    <div class="stage-container">
                        <div class="stage-card">
                            <label>Matem√°tica</label>
                            <input type="text" id="mathStage" class="stage-input" placeholder="Ex: C150">
                        </div>
                        <div class="stage-card">
                            <label>Portugu√™s</label>
                            <input type="text" id="portStage" class="stage-input" placeholder="Ex: CII 100">
                        </div>
                        <div class="stage-card">
                            <label>Ingl√™s</label>
                            <input type="text" id="engStage" class="stage-input" placeholder="Ex: G50">
                        </div>
                        <button id="saveStagesBtn" class="btn btn-primary"><i class='bx bx-save'></i> Salvar Est√°gios</button>
                    </div>

                    <!-- Abas de Conte√∫do (Boletins, Reuni√µes) -->
                    <div class="tabs">
                        <button class="tab-link active" onclick="App.openTab(event, 'tabBoletim')">
                            <i class='bx bx-spreadsheet'></i> Folha de Registro
                        </button>
                        <button class="tab-link" onclick="App.openTab(event, 'tabReunioes')">
                            <i class='bx bx-conversation'></i> Di√°rio de Reuni√µes
                        </button>
                        <!-- NOVO (V2): Aba para o novo log -->
                        <button class="tab-link" onclick="App.openTab(event, 'tabPerformance')">
                            <i class='bx bx-task'></i> Log de Tarefas (IA)
                        </button>
                    </div>

                    <!-- Conte√∫do da Aba: Boletim (Folha de Registro) -->
                    <div id="tabBoletim" class="tab-content active">
                        <div class="tab-header">
                            <h3>Hist√≥rico da Folha de Registro</h3>
                            <button id="openAddGradeBtn" class="btn btn-secondary">
                                <i class='bx bx-plus'></i> Lan√ßar Boletim
                            </button>
                        </div>
                        <div id="gradeHistory" class="history-list">
                            <!-- Hist√≥rico de boletins carregado pelo app.js -->
                        </div>
                    </div>
                    
                    <!-- Conte√∫do da Aba: Reuni√µes -->
                    <div id="tabReunioes" class="tab-content">
                        <div class="tab-header">
                            <h3>Hist√≥rico de Reuni√µes</h3>
                            <button id="openMeetingBtn" class="btn btn-secondary">
                                <i class='bx bx-plus'></i> Nova Reuni√£o (IA)
                            </button>
                        </div>
                        <div id="meetingHistory" class="history-list">
                            <!-- Hist√≥rico de reuni√µes carregado pelo app.js -->
                        </div>
                    </div>
                    
                    <!-- NOVO (V2): Conte√∫do da Aba: Log de Performance (IA) -->
                    <div id="tabPerformance" class="tab-content">
                        <div class="tab-header">
                            <h3>Log de Tarefas Analisadas (IA)</h3>
                            <button id="openTaskAnalysisBtn" class="btn btn-warning">
                                <i class='bx bx-images'></i> Analisar Tarefas (IA)
                            </button>
                        </div>
                        <div id="performanceLogContainer" class="performance-log-container">
                            <!-- Log de performance da V2 ser√° carregado aqui -->
                        </div>
                    </div>

                </div>
            </section>
        </main>
    </div>

    <!-- =================================================================== -->
    <!-- ======================= MODAIS DA APLICA√á√ÉO ===================== -->
    <!-- =================================================================== -->

    <!-- Modal: Adicionar Aluno -->
    <div id="studentModal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="studentModalTitle">Adicionar Novo Aluno</h2>
                <button id="closeStudentModalBtn" class="close-btn">&times;</button>
            </div>
            <form id="studentForm" class="modal-body">
                <input type="hidden" id="studentId">
                <div class="form-section">
                    <div class="form-group">
                        <label for="studentName">Nome do Aluno</label>
                        <input type="text" id="studentName" required>
                    </div>
                    <div class="form-group">
                        <label for="studentResponsible">Nome do Respons√°vel</label>
                        <input type="text" id="studentResponsible">
                    </div>
                    <div class="form-group">
                        <label for="studentContact">Telefone (Respons√°vel)</label>
                        <input type="tel" id="studentContact" placeholder="(XX) 9XXXX-XXXX">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" id="deleteStudentBtn" class="btn btn-danger hidden" style="margin-right: auto;">Excluir Aluno</button>
                    <button type="submit" class="btn btn-primary">Salvar Aluno</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Adicionar Boletim (Folha de Registro) -->
    <div id="gradeModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2>Lan√ßar Boletim / Folha de Registro</h2>
                <button id="closeGradeModalBtn" class="close-btn">&times;</button>
            </div>
            <form id="gradeForm" class="modal-body">
                <div class="form-section">
                    <div class="form-group">
                        <label for="gradeSubject">Mat√©ria</label>
                        <select id="gradeSubject" required>
                            <option value="Matem√°tica">Matem√°tica</option>
                            <option value="Portugu√™s">Portugu√™s</option>
                            <option value="Ingl√™s">Ingl√™s</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="gradeDate">Data do Boletim</label>
                        <input type="date" id="gradeDate" required>
                    </div>
                    <div class="form-group">
                        <label for="gradeValue">Nota/Conceito (Ex: 8.5 ou A)</label>
                        <input type="text" id="gradeValue" placeholder="Nota" required>
                    </div>
                    <div class="form-group">
                        <label for="gradeAttachment">Anexar Boletim (Opcional)</label>
                        <input type="file" id="gradeAttachment" accept="image/*,application/pdf">
                        <button type="button" id="uploadAttachmentBtn" class="btn btn-secondary" style="width: auto; margin-top: 10px;">
                            <i class='bx bx-upload'></i> Enviar Anexo
                        </button>
                        <div id="attachmentStatus"></div>
                        <input type="hidden" id="gradeAttachmentUrl">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">Salvar Lan√ßamento</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Di√°rio de Reuni√£o (IA) -->
    <div id="meetingModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2>Di√°rio de Reuni√£o (com IA)</h2>
                <button id="closeMeetingModalBtn" class="close-btn">&times;</button>
            </div>
            <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                <form id="meetingForm">
                    <p class="form-intro">Descreva a reuni√£o ou cole a transcri√ß√£o. A IA ir√° analisar e gerar o diagn√≥stico e plano de a√ß√£o.</p>
                    
                    <fieldset>
                        <legend>Dados da Reuni√£o</legend>
                        <div class="form-group">
                            <label for="meetingDate">Data da Reuni√£o</label>
                            <input type="date" id="meetingDate" required>
                        </div>
                        <div class="form-group">
                            <label for="meetingTranscription">Transcri√ß√£o ou Resumo da Reuni√£o</label>
                            <textarea id="meetingTranscription" rows="10" placeholder="Cole a transcri√ß√£o do √°udio ou digite o resumo da conversa com os pais/aluno..."></textarea>
                        </div>
                    </fieldset>
                    
                    <div class="analysis-section">
                        <div class="analysis-header">
                            <h4><i class='bx bxs-magic-wand'></i> An√°lise da IA (Gemini)</h4>
                            <button type="submit" id="generateAnalysisBtn" class="btn btn-primary">
                                <i class='bx bx-brain'></i> Gerar An√°lise
                            </button>
                        </div>
                        <div id="analysisResult" class="analysis-content" style="min-height: 150px;">
                            Aguardando gera√ß√£o da an√°lise...
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal: Visualizar Relat√≥rio de Reuni√£o -->
    <div id="reportModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2 id="reportModalTitle">Relat√≥rio da Reuni√£o</h2>
                <button id="closeReportModalBtn" class="close-btn">&times;</button>
            </div>
            <div id="reportModalBody" class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                <!-- Conte√∫do do relat√≥rio (JSON formatado) ser√° injetado aqui -->
            </div>
        </div>
    </div>

    <!-- Modal: Dashboard Geral -->
    <div id="dashboardModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2>Dashboard Geral da Unidade</h2>
                <button id="closeDashboardBtn" class="close-btn">&times;</button>
            </div>
            <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                <div class="kpi-container">
                    <div class="kpi-card">
                        <span id="kpiTotalAlunos" class="kpi-number">0</span>
                        <span class="kpi-label">Total de Alunos</span>
                    </div>
                    <div class="kpi-card">
                        <span id="kpiAlunosMat" class="kpi-number">0</span>
                        <span class="kpi-label">Alunos em Mat</span>
                    </div>
                    <div class="kpi-card">
                        <span id="kpiAlunosPort" class="kpi-number">0</span>
                        <span class="kpi-label">Alunos em Port</span>
                    </div>
                    <div class="kpi-card">
                        <span id="kpiAlunosEng" class="kpi-number">0</span>
                        <span class="kpi-label">Alunos em Ingl√™s</span>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="stageChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal: Admin (C√©rebro da IA) -->
    <div id="brainModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2>üß† Atualizar C√©rebro da IA (Admin)</h2>
                <button id="closeBrainModalBtn" class="close-btn">&times;</button>
            </div>
            <div class="modal-body">
                <fieldset>
                    <legend>Upload de Contexto</legend>
                    <div class="form-section">
                        <label for="brainFileUploadModal">üìÅ Enviar novo arquivo JSON com informa√ß√µes da franquia</label>
                        <input type="file" id="brainFileUploadModal" accept=".json" />
                        <button id="uploadBrainFileBtnModal" class="btn">Enviar e Atualizar</button>
                        <p class="text-sm text-gray-500 mt-1">Este arquivo ser√° mesclado com o 'brain.json' atual no banco de dados.</p>
                    </div>
                </fieldset>
            </div>
        </div>
    </div>
    
    <!-- NOVO (V2): Modal de An√°lise de Tarefas (IA) -->
    <div id="taskAnalysisModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h2>Analisar Tarefas com IA (Multimodal)</h2>
                <button id="closeTaskAnalysisModalBtn" class="close-btn">&times;</button>
            </div>
            <div class="modal-body">
                <form id="taskAnalysisForm">
                    <fieldset>
                        <legend>1. Upload das Imagens</legend>
                        <div class="form-group">
                            <label for="taskFilesInput">Selecione as fotos das tarefas (boletins, folhas, etc.)</label>
                            <input type="file" id="taskFilesInput" accept="image/*" multiple required>
                            <p class="text-sm text-gray-500 mt-1">Voc√™ pode selecionar m√∫ltiplas imagens de uma vez.</p>
                        </div>
                    </fieldset>
                    
                    <fieldset>
                        <legend>2. Processamento</legend>
                        <button type="submit" id="startTaskAnalysisBtn" class="btn btn-primary">
                            <i class='bx bx-images'></i> Iniciar An√°lise da Fila
                        </button>
                        
                        <!-- Status do Processamento -->
                        <div id="taskAnalysisStatusContainer" class="hidden" style="margin-top: 20px;">
                            <div id="taskAnalysisStatus">Processando...</div>
                            <div id="taskAnalysisProgress">
                                <div id="taskAnalysisProgressBar">0%</div>
                            </div>
                        </div>
                    </fieldset>
                </form>
            </div>
        </div>
    </div>


    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://upload-widget.cloudinary.com/global/all.js" type="text/javascript"></script> 
    
    <!-- Corrigido para a pasta 'js/' (um 's') -->
    <script src="js/config.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/app.js"></script>

</body>
</html>
